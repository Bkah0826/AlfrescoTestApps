/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
/*!
 * @license
 * Copyright 2019 Alfresco Software, Ltd.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
import { FileModel } from '@alfresco/adf-core';
import { EventEmitter, Input, Output } from '@angular/core';
import { Subject } from 'rxjs';
import { UploadFilesEvent } from '../upload-files.event';
import { takeUntil } from 'rxjs/operators';
/**
 * @abstract
 */
export class UploadBase {
    /**
     * @param {?} uploadService
     * @param {?} translationService
     * @param {?} ngZone
     */
    constructor(uploadService, translationService, ngZone) {
        this.uploadService = uploadService;
        this.translationService = translationService;
        this.ngZone = ngZone;
        /**
         * The ID of the root. Use the nodeId for
         * Content Services or the taskId/processId for Process Services.
         */
        this.rootFolderId = '-root-';
        /**
         * Toggles component disabled state (if there is no node permission checking).
         */
        this.disabled = false;
        /**
         * Filter for accepted file types.
         */
        this.acceptedFilesType = '*';
        /**
         * Toggles versioning.
         */
        this.versioning = false;
        /**
         * majorVersion boolean field to true to indicate a major version should be created.
         */
        this.majorVersion = false;
        /**
         * Custom node type for uploaded file
         */
        this.nodeType = 'cm:content';
        /**
         * Emitted when the file is uploaded successfully.
         */
        this.success = new EventEmitter();
        /**
         * Emitted when an error occurs.
         */
        this.error = new EventEmitter();
        /**
         * Emitted when the upload begins.
         */
        this.beginUpload = new EventEmitter();
        this.onDestroy$ = new Subject();
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.uploadService.fileUploadError
            .pipe(takeUntil(this.onDestroy$))
            .subscribe((/**
         * @param {?} error
         * @return {?}
         */
        error => this.error.emit(error)));
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.onDestroy$.next(true);
        this.onDestroy$.complete();
    }
    /**
     * Upload a list of file in the specified path
     * @param {?} files
     * @return {?}
     */
    uploadFiles(files) {
        /** @type {?} */
        const filteredFiles = files
            .map((/**
         * @param {?} file
         * @return {?}
         */
        (file) => {
            return this.createFileModel(file, this.rootFolderId, (((/** @type {?} */ (file))).webkitRelativePath || '').replace(/\/[^\/]*$/, ''));
        }));
        this.uploadQueue(filteredFiles);
    }
    /**
     * @param {?} files
     * @return {?}
     */
    uploadFilesInfo(files) {
        /** @type {?} */
        const filteredFiles = files
            .map((/**
         * @param {?} fileInfo
         * @return {?}
         */
        (fileInfo) => {
            return this.createFileModel(fileInfo.file, this.rootFolderId, fileInfo.relativeFolder);
        }));
        this.uploadQueue(filteredFiles);
    }
    /**
     * @private
     * @param {?} files
     * @return {?}
     */
    uploadQueue(files) {
        /** @type {?} */
        const filteredFiles = files
            .filter(this.isFileAcceptable.bind(this))
            .filter(this.isFileSizeAcceptable.bind(this));
        this.ngZone.run((/**
         * @return {?}
         */
        () => {
            /** @type {?} */
            const event = new UploadFilesEvent([...filteredFiles], this.uploadService, this.success);
            this.beginUpload.emit(event);
            if (!event.defaultPrevented) {
                if (filteredFiles.length > 0) {
                    this.uploadService.addToQueue(...filteredFiles);
                    this.uploadService.uploadFilesInTheQueue(this.success);
                }
            }
        }));
    }
    /**
     * Checks if the given file is allowed by the extension filters
     *
     * @protected
     * @param {?} file FileModel
     * @return {?}
     */
    isFileAcceptable(file) {
        if (this.acceptedFilesType === '*') {
            return true;
        }
        /** @type {?} */
        const allowedExtensions = this.acceptedFilesType
            .split(',')
            .map((/**
         * @param {?} ext
         * @return {?}
         */
        (ext) => ext.trim().replace(/^\./, '')));
        if (allowedExtensions.indexOf(file.extension) !== -1) {
            return true;
        }
        return false;
    }
    /**
     * Creates FileModel from File
     *
     * @protected
     * @param {?} file
     * @param {?} parentId
     * @param {?} path
     * @param {?=} id
     * @return {?}
     */
    createFileModel(file, parentId, path, id) {
        return new FileModel(file, {
            comment: this.comment,
            majorVersion: this.majorVersion,
            newVersion: this.versioning,
            parentId: parentId,
            path: path,
            nodeType: this.nodeType
        }, id);
    }
    /**
     * @protected
     * @param {?} file
     * @return {?}
     */
    isFileSizeAllowed(file) {
        /** @type {?} */
        let isFileSizeAllowed = true;
        if (this.isMaxFileSizeDefined()) {
            isFileSizeAllowed = this.isFileSizeCorrect(file);
        }
        return isFileSizeAllowed;
    }
    /**
     * @protected
     * @return {?}
     */
    isMaxFileSizeDefined() {
        return this.maxFilesSize !== undefined && this.maxFilesSize !== null;
    }
    /**
     * @protected
     * @param {?} file
     * @return {?}
     */
    isFileSizeCorrect(file) {
        return this.maxFilesSize >= 0 && file.size <= this.maxFilesSize;
    }
    /**
     * Checks if the given file is an acceptable size
     *
     * @private
     * @param {?} file FileModel
     * @return {?}
     */
    isFileSizeAcceptable(file) {
        /** @type {?} */
        let acceptableSize = true;
        if (!this.isFileSizeAllowed(file)) {
            acceptableSize = false;
            /** @type {?} */
            const message = this.translationService.instant('FILE_UPLOAD.MESSAGES.EXCEED_MAX_FILE_SIZE', { fileName: file.name });
            this.error.emit(message);
        }
        return acceptableSize;
    }
}
UploadBase.propDecorators = {
    maxFilesSize: [{ type: Input }],
    rootFolderId: [{ type: Input }],
    disabled: [{ type: Input }],
    acceptedFilesType: [{ type: Input }],
    versioning: [{ type: Input }],
    majorVersion: [{ type: Input }],
    comment: [{ type: Input }],
    nodeType: [{ type: Input }],
    success: [{ type: Output }],
    error: [{ type: Output }],
    beginUpload: [{ type: Output }]
};
if (false) {
    /**
     * Sets a limit on the maximum size (in bytes) of a file to be uploaded.
     * Has no effect if undefined.
     * @type {?}
     */
    UploadBase.prototype.maxFilesSize;
    /**
     * The ID of the root. Use the nodeId for
     * Content Services or the taskId/processId for Process Services.
     * @type {?}
     */
    UploadBase.prototype.rootFolderId;
    /**
     * Toggles component disabled state (if there is no node permission checking).
     * @type {?}
     */
    UploadBase.prototype.disabled;
    /**
     * Filter for accepted file types.
     * @type {?}
     */
    UploadBase.prototype.acceptedFilesType;
    /**
     * Toggles versioning.
     * @type {?}
     */
    UploadBase.prototype.versioning;
    /**
     * majorVersion boolean field to true to indicate a major version should be created.
     * @type {?}
     */
    UploadBase.prototype.majorVersion;
    /**
     * When you overwrite existing content, you can use the comment field to add a version comment that appears in the version history
     * @type {?}
     */
    UploadBase.prototype.comment;
    /**
     * Custom node type for uploaded file
     * @type {?}
     */
    UploadBase.prototype.nodeType;
    /**
     * Emitted when the file is uploaded successfully.
     * @type {?}
     */
    UploadBase.prototype.success;
    /**
     * Emitted when an error occurs.
     * @type {?}
     */
    UploadBase.prototype.error;
    /**
     * Emitted when the upload begins.
     * @type {?}
     */
    UploadBase.prototype.beginUpload;
    /**
     * @type {?}
     * @protected
     */
    UploadBase.prototype.onDestroy$;
    /**
     * @type {?}
     * @protected
     */
    UploadBase.prototype.uploadService;
    /**
     * @type {?}
     * @protected
     */
    UploadBase.prototype.translationService;
    /**
     * @type {?}
     * @protected
     */
    UploadBase.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkLWJhc2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYWxmcmVzY28vYWRmLWNvbnRlbnQtc2VydmljZXMvIiwic291cmNlcyI6WyJ1cGxvYWQvY29tcG9uZW50cy9iYXNlLXVwbG9hZC91cGxvYWQtYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxPQUFPLEVBQUUsU0FBUyxFQUFZLE1BQU0sb0JBQW9CLENBQUM7QUFDekQsT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUE2QixNQUFNLGVBQWUsQ0FBQztBQUV2RixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUUzQyxNQUFNLE9BQWdCLFVBQVU7Ozs7OztJQW9ENUIsWUFBc0IsYUFBNEIsRUFDNUIsa0JBQXNDLEVBQ3RDLE1BQWM7UUFGZCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLFdBQU0sR0FBTixNQUFNLENBQVE7Ozs7O1FBMUNwQyxpQkFBWSxHQUFXLFFBQVEsQ0FBQzs7OztRQUloQyxhQUFRLEdBQVksS0FBSyxDQUFDOzs7O1FBSTFCLHNCQUFpQixHQUFXLEdBQUcsQ0FBQzs7OztRQUloQyxlQUFVLEdBQVksS0FBSyxDQUFDOzs7O1FBSTVCLGlCQUFZLEdBQVksS0FBSyxDQUFDOzs7O1FBUTlCLGFBQVEsR0FBVyxZQUFZLENBQUM7Ozs7UUFJaEMsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7Ozs7UUFJN0IsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7Ozs7UUFJM0IsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBb0IsQ0FBQztRQUV6QyxlQUFVLEdBQUcsSUFB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LElBQUksQ0FBQyxFQUFFO1lBQy9CLGNBQWMsR0FBRyxLQUFLLENBQUM7O2tCQUVqQixPQUFPLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FDM0MsMkNBQTJDLEVBQzNDLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FDMUI7WUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM1QjtRQUVELE9BQU8sY0FBYyxDQUFDO0lBQzFCLENBQUM7OzsyQkF0TEEsS0FBSzsyQkFNTCxLQUFLO3VCQUlMLEtBQUs7Z0NBSUwsS0FBSzt5QkFJTCxLQUFLOzJCQUlMLEtBQUs7c0JBSUwsS0FBSzt1QkFJTCxLQUFLO3NCQUlMLE1BQU07b0JBSU4sTUFBTTswQkFJTixNQUFNOzs7Ozs7OztJQTFDUCxrQ0FDcUI7Ozs7OztJQUtyQixrQ0FDZ0M7Ozs7O0lBR2hDLDhCQUMwQjs7Ozs7SUFHMUIsdUNBQ2dDOzs7OztJQUdoQyxnQ0FDNEI7Ozs7O0lBRzVCLGtDQUM4Qjs7Ozs7SUFHOUIsNkJBQ2dCOzs7OztJQUdoQiw4QkFDZ0M7Ozs7O0lBR2hDLDZCQUM2Qjs7Ozs7SUFHN0IsMkJBQzJCOzs7OztJQUczQixpQ0FDbUQ7Ozs7O0lBRW5ELGdDQUE4Qzs7Ozs7SUFFbEMsbUNBQXNDOzs7OztJQUN0Qyx3Q0FBZ0Q7Ozs7O0lBQ2hELDRCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbIi8qIVxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEFsZnJlc2NvIFNvZnR3YXJlLCBMdGQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKTtcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEZpbGVNb2RlbCwgRmlsZUluZm8gfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBPbkluaXQsIE9uRGVzdHJveSwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBVcGxvYWRTZXJ2aWNlLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgVXBsb2FkRmlsZXNFdmVudCB9IGZyb20gJy4uL3VwbG9hZC1maWxlcy5ldmVudCc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBVcGxvYWRCYXNlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gICAgLyoqIFNldHMgYSBsaW1pdCBvbiB0aGUgbWF4aW11bSBzaXplIChpbiBieXRlcykgb2YgYSBmaWxlIHRvIGJlIHVwbG9hZGVkLlxuICAgICAqIEhhcyBubyBlZmZlY3QgaWYgdW5kZWZpbmVkLlxuICAgICAqL1xuICAgIEBJbnB1dCgpXG4gICAgbWF4RmlsZXNTaXplOiBudW1iZXI7XG5cbiAgICAvKiogVGhlIElEIG9mIHRoZSByb290LiBVc2UgdGhlIG5vZGVJZCBmb3JcbiAgICAgKiBDb250ZW50IFNlcnZpY2VzIG9yIHRoZSB0YXNrSWQvcHJvY2Vzc0lkIGZvciBQcm9jZXNzIFNlcnZpY2VzLlxuICAgICAqL1xuICAgIEBJbnB1dCgpXG4gICAgcm9vdEZvbGRlcklkOiBzdHJpbmcgPSAnLXJvb3QtJztcblxuICAgIC8qKiBUb2dnbGVzIGNvbXBvbmVudCBkaXNhYmxlZCBzdGF0ZSAoaWYgdGhlcmUgaXMgbm8gbm9kZSBwZXJtaXNzaW9uIGNoZWNraW5nKS4gKi9cbiAgICBASW5wdXQoKVxuICAgIGRpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogRmlsdGVyIGZvciBhY2NlcHRlZCBmaWxlIHR5cGVzLiAqL1xuICAgIEBJbnB1dCgpXG4gICAgYWNjZXB0ZWRGaWxlc1R5cGU6IHN0cmluZyA9ICcqJztcblxuICAgIC8qKiBUb2dnbGVzIHZlcnNpb25pbmcuICovXG4gICAgQElucHV0KClcbiAgICB2ZXJzaW9uaW5nOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAvKiogbWFqb3JWZXJzaW9uIGJvb2xlYW4gZmllbGQgdG8gdHJ1ZSB0byBpbmRpY2F0ZSBhIG1ham9yIHZlcnNpb24gc2hvdWxkIGJlIGNyZWF0ZWQuICovXG4gICAgQElucHV0KClcbiAgICBtYWpvclZlcnNpb246IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgIC8qKiBXaGVuIHlvdSBvdmVyd3JpdGUgZXhpc3RpbmcgY29udGVudCwgeW91IGNhbiB1c2UgdGhlIGNvbW1lbnQgZmllbGQgdG8gYWRkIGEgdmVyc2lvbiBjb21tZW50IHRoYXQgYXBwZWFycyBpbiB0aGUgdmVyc2lvbiBoaXN0b3J5ICovXG4gICAgQElucHV0KClcbiAgICBjb21tZW50OiBzdHJpbmc7XG5cbiAgICAvKiogQ3VzdG9tIG5vZGUgdHlwZSBmb3IgdXBsb2FkZWQgZmlsZSAqL1xuICAgIEBJbnB1dCgpXG4gICAgbm9kZVR5cGU6IHN0cmluZyA9ICdjbTpjb250ZW50JztcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIGZpbGUgaXMgdXBsb2FkZWQgc3VjY2Vzc2Z1bGx5LiAqL1xuICAgIEBPdXRwdXQoKVxuICAgIHN1Y2Nlc3MgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgICAvKiogRW1pdHRlZCB3aGVuIGFuIGVycm9yIG9jY3Vycy4gKi9cbiAgICBAT3V0cHV0KClcbiAgICBlcnJvciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIC8qKiBFbWl0dGVkIHdoZW4gdGhlIHVwbG9hZCBiZWdpbnMuICovXG4gICAgQE91dHB1dCgpXG4gICAgYmVnaW5VcGxvYWQgPSBuZXcgRXZlbnRFbWl0dGVyPFVwbG9hZEZpbGVzRXZlbnQ+KCk7XG5cbiAgICBwcm90ZWN0ZWQgb25EZXN0cm95JCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgdXBsb2FkU2VydmljZTogVXBsb2FkU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgdHJhbnNsYXRpb25TZXJ2aWNlOiBUcmFuc2xhdGlvblNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIG5nWm9uZTogTmdab25lKSB7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKSB7XG4gICAgICAgIHRoaXMudXBsb2FkU2VydmljZS5maWxlVXBsb2FkRXJyb3JcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLm9uRGVzdHJveSQpKVxuICAgICAgICAgICAgLnN1YnNjcmliZShlcnJvciA9PiB0aGlzLmVycm9yLmVtaXQoZXJyb3IpKTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5vbkRlc3Ryb3kkLm5leHQodHJ1ZSk7XG4gICAgICAgIHRoaXMub25EZXN0cm95JC5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwbG9hZCBhIGxpc3Qgb2YgZmlsZSBpbiB0aGUgc3BlY2lmaWVkIHBhdGhcbiAgICAgKiBAcGFyYW0gZmlsZXNcbiAgICAgKiBAcGFyYW0gcGF0aFxuICAgICAqL1xuICAgIHVwbG9hZEZpbGVzKGZpbGVzOiBGaWxlW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZmlsdGVyZWRGaWxlczogRmlsZU1vZGVsW10gPSBmaWxlc1xuICAgICAgICAgICAgLm1hcDxGaWxlTW9kZWw+KChmaWxlOiBGaWxlKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRmlsZU1vZGVsKGZpbGUsIHRoaXMucm9vdEZvbGRlcklkLCAoKDxhbnk+IGZpbGUpLndlYmtpdFJlbGF0aXZlUGF0aCB8fCAnJykucmVwbGFjZSgvXFwvW15cXC9dKiQvLCAnJykpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy51cGxvYWRRdWV1ZShmaWx0ZXJlZEZpbGVzKTtcbiAgICB9XG5cbiAgICB1cGxvYWRGaWxlc0luZm8oZmlsZXM6IEZpbGVJbmZvW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgZmlsdGVyZWRGaWxlczogRmlsZU1vZGVsW10gPSBmaWxlc1xuICAgICAgICAgICAgLm1hcDxGaWxlTW9kZWw+KChmaWxlSW5mbzogRmlsZUluZm8pID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVGaWxlTW9kZWwoZmlsZUluZm8uZmlsZSwgdGhpcy5yb290Rm9sZGVySWQsIGZpbGVJbmZvLnJlbGF0aXZlRm9sZGVyKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudXBsb2FkUXVldWUoZmlsdGVyZWRGaWxlcyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGxvYWRRdWV1ZShmaWxlczogRmlsZU1vZGVsW10pIHtcbiAgICAgICAgY29uc3QgZmlsdGVyZWRGaWxlcyA9IGZpbGVzXG4gICAgICAgICAgICAuZmlsdGVyKHRoaXMuaXNGaWxlQWNjZXB0YWJsZS5iaW5kKHRoaXMpKVxuICAgICAgICAgICAgLmZpbHRlcih0aGlzLmlzRmlsZVNpemVBY2NlcHRhYmxlLmJpbmQodGhpcykpO1xuXG4gICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBVcGxvYWRGaWxlc0V2ZW50KFxuICAgICAgICAgICAgICAgIFsuLi5maWx0ZXJlZEZpbGVzXSxcbiAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgdGhpcy5zdWNjZXNzXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgdGhpcy5iZWdpblVwbG9hZC5lbWl0KGV2ZW50KTtcblxuICAgICAgICAgICAgaWYgKCFldmVudC5kZWZhdWx0UHJldmVudGVkKSB7XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcmVkRmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNlcnZpY2UuYWRkVG9RdWV1ZSguLi5maWx0ZXJlZEZpbGVzKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRTZXJ2aWNlLnVwbG9hZEZpbGVzSW5UaGVRdWV1ZSh0aGlzLnN1Y2Nlc3MpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBmaWxlIGlzIGFsbG93ZWQgYnkgdGhlIGV4dGVuc2lvbiBmaWx0ZXJzXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmlsZSBGaWxlTW9kZWxcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgaXNGaWxlQWNjZXB0YWJsZShmaWxlOiBGaWxlTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKHRoaXMuYWNjZXB0ZWRGaWxlc1R5cGUgPT09ICcqJykge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBhbGxvd2VkRXh0ZW5zaW9ucyA9IHRoaXMuYWNjZXB0ZWRGaWxlc1R5cGVcbiAgICAgICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgICAgICAubWFwKChleHQpID0+IGV4dC50cmltKCkucmVwbGFjZSgvXlxcLi8sICcnKSk7XG5cbiAgICAgICAgaWYgKGFsbG93ZWRFeHRlbnNpb25zLmluZGV4T2YoZmlsZS5leHRlbnNpb24pICE9PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ3JlYXRlcyBGaWxlTW9kZWwgZnJvbSBGaWxlXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmlsZVxuICAgICAqL1xuICAgIHByb3RlY3RlZCBjcmVhdGVGaWxlTW9kZWwoZmlsZTogRmlsZSwgcGFyZW50SWQ6IHN0cmluZywgcGF0aDogc3RyaW5nLCBpZD86IHN0cmluZyk6IEZpbGVNb2RlbCB7XG4gICAgICAgIHJldHVybiBuZXcgRmlsZU1vZGVsKGZpbGUsIHtcbiAgICAgICAgICAgIGNvbW1lbnQ6IHRoaXMuY29tbWVudCxcbiAgICAgICAgICAgIG1ham9yVmVyc2lvbjogdGhpcy5tYWpvclZlcnNpb24sXG4gICAgICAgICAgICBuZXdWZXJzaW9uOiB0aGlzLnZlcnNpb25pbmcsXG4gICAgICAgICAgICBwYXJlbnRJZDogcGFyZW50SWQsXG4gICAgICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICAgICAgbm9kZVR5cGU6IHRoaXMubm9kZVR5cGVcbiAgICAgICAgfSwgaWQpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpc0ZpbGVTaXplQWxsb3dlZChmaWxlOiBGaWxlTW9kZWwpIHtcbiAgICAgICAgbGV0IGlzRmlsZVNpemVBbGxvd2VkID0gdHJ1ZTtcbiAgICAgICAgaWYgKHRoaXMuaXNNYXhGaWxlU2l6ZURlZmluZWQoKSkge1xuICAgICAgICAgICAgaXNGaWxlU2l6ZUFsbG93ZWQgPSB0aGlzLmlzRmlsZVNpemVDb3JyZWN0KGZpbGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGlzRmlsZVNpemVBbGxvd2VkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBpc01heEZpbGVTaXplRGVmaW5lZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4RmlsZXNTaXplICE9PSB1bmRlZmluZWQgJiYgdGhpcy5tYXhGaWxlc1NpemUgIT09IG51bGw7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGlzRmlsZVNpemVDb3JyZWN0KGZpbGU6IEZpbGVNb2RlbCkge1xuICAgICAgICByZXR1cm4gdGhpcy5tYXhGaWxlc1NpemUgPj0gMCAmJiBmaWxlLnNpemUgPD0gdGhpcy5tYXhGaWxlc1NpemU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBmaWxlIGlzIGFuIGFjY2VwdGFibGUgc2l6ZVxuICAgICAqXG4gICAgICogQHBhcmFtIGZpbGUgRmlsZU1vZGVsXG4gICAgICovXG4gICAgcHJpdmF0ZSBpc0ZpbGVTaXplQWNjZXB0YWJsZShmaWxlOiBGaWxlTW9kZWwpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGFjY2VwdGFibGVTaXplID0gdHJ1ZTtcblxuICAgICAgICBpZiAoIXRoaXMuaXNGaWxlU2l6ZUFsbG93ZWQoZmlsZSkpIHtcbiAgICAgICAgICAgIGFjY2VwdGFibGVTaXplID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0aGlzLnRyYW5zbGF0aW9uU2VydmljZS5pbnN0YW50KFxuICAgICAgICAgICAgICAgICdGSUxFX1VQTE9BRC5NRVNTQUdFUy5FWENFRURfTUFYX0ZJTEVfU0laRScsXG4gICAgICAgICAgICAgICAgeyBmaWxlTmFtZTogZmlsZS5uYW1lIH1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHRoaXMuZXJyb3IuZW1pdChtZXNzYWdlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhY2NlcHRhYmxlU2l6ZTtcbiAgICB9XG5cbn1cbiJdfQ==